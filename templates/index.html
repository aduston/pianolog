<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pianolog - Practice Tracker</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .status-card {
            text-align: center;
        }

        .status-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-indicator.active {
            background-color: #4CAF50;
        }

        .status-indicator.inactive {
            background-color: #ccc;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .status-text {
            font-size: 1.5em;
            font-weight: 600;
            margin: 20px 0;
        }

        .session-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .info-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .info-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #667eea;
        }

        .user-selector {
            margin-top: 30px;
        }

        .user-selector h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .user-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .user-button {
            flex: 1;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border: 3px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .user-button.active {
            background: #667eea;
            color: white;
        }

        .recent-sessions {
            margin-top: 20px;
        }

        .recent-sessions h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .session-list {
            list-style: none;
        }

        .session-item {
            padding: 15px;
            background: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-item:hover {
            background: #f0f0f0;
        }

        .session-user {
            font-weight: 600;
            color: #667eea;
        }

        .session-details {
            color: #666;
            font-size: 0.9em;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            font-size: 0.9em;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .connection-status.connected {
            color: #4CAF50;
        }

        .connection-status.disconnected {
            color: #f44336;
        }

        .midi-status {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .midi-status.connected {
            border-left: 4px solid #4CAF50;
        }

        .midi-status.disconnected {
            border-left: 4px solid #f44336;
        }

        .midi-status-text {
            font-weight: 600;
        }

        .midi-status.connected .midi-status-text {
            color: #4CAF50;
        }

        .midi-status.disconnected .midi-status-text {
            color: #f44336;
        }

        .midi-device-name {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .retry-button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .retry-button:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .retry-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .session-controls {
            margin-top: 20px;
            display: none;
            gap: 10px;
        }

        .session-controls.active {
            display: flex;
            justify-content: center;
        }

        .end-session-button {
            padding: 12px 24px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .end-session-button:hover {
            background: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        .end-session-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .user-selector h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .user-selector.during-session h3 {
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">Connecting...</div>

    <div class="container">
        <header>
            <h1>ðŸŽ¹ Pianolog</h1>
            <p>Piano Practice Tracker</p>
        </header>

        <!-- MIDI Status -->
        <div class="midi-status" id="midiStatus">
            <div>
                <div class="midi-status-text" id="midiStatusText">Checking MIDI...</div>
                <div class="midi-device-name" id="midiDeviceName"></div>
            </div>
            <button class="retry-button" id="retryButton" onclick="retryMidiConnection()" style="display: none;">Retry Connection</button>
        </div>

        <div class="card status-card">
            <div class="status-text">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">Loading...</span>
            </div>

            <div class="session-info" id="sessionInfo" style="display: none;">
                <div class="info-box">
                    <div class="info-label">Duration</div>
                    <div class="info-value" id="duration">0:00</div>
                </div>
                <div class="info-box">
                    <div class="info-label">Notes Played</div>
                    <div class="info-value" id="noteCount">0</div>
                </div>
            </div>

            <div class="user-selector" id="userSelector">
                <h3 id="userSelectorTitle">Who's practicing?</h3>
                <div class="user-buttons" id="userButtons">
                    <!-- User buttons will be dynamically generated -->
                </div>
            </div>

            <div class="session-controls" id="sessionControls">
                <button class="end-session-button" id="endSessionButton" onclick="endSession()">End Session</button>
            </div>
        </div>

        <div class="card recent-sessions">
            <h3>Recent Sessions</h3>
            <ul class="session-list" id="recentSessions">
                <li class="session-item">Loading...</li>
            </ul>
        </div>
    </div>

    <script>
        // Connect to WebSocket
        // Detect if we're behind a proxy at /pianolog/
        const basePath = window.location.pathname.startsWith('/pianolog') ? '/pianolog' : '';
        const socket = io({
            path: basePath + '/socket.io'
        });

        let currentSession = null;
        let durationTimer = null;
        let configuredUsers = [];
        let midiConnected = false;

        // Connection status
        socket.on('connect', () => {
            console.log('Connected to server');
            document.getElementById('connectionStatus').textContent = 'WebSocket Connected';
            document.getElementById('connectionStatus').className = 'connection-status connected';
            loadUsers();
            loadMidiStatus();
            loadStatus();
            loadRecentSessions();
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
        });

        // Session events
        socket.on('session_started', (data) => {
            console.log('Session started:', data);
            currentSession = data;
            updateStatus();
            loadRecentSessions();
        });

        socket.on('session_ended', (data) => {
            console.log('Session ended:', data);
            currentSession = null;
            updateStatus();
            loadRecentSessions();
        });

        socket.on('session_activity', (data) => {
            console.log('Session activity:', data);
            if (currentSession) {
                currentSession.note_count = data.note_count;
                currentSession.duration = data.duration;
                updateSessionInfo();
            }
        });

        socket.on('user_changed', (data) => {
            console.log('User changed:', data);
            loadStatus();
        });

        socket.on('midi_connected', (data) => {
            console.log('MIDI connected:', data);
            midiConnected = true;
            updateMidiStatus(true, data.device);
        });

        socket.on('midi_disconnected', (data) => {
            console.log('MIDI disconnected:', data);
            midiConnected = false;
            updateMidiStatus(false, null);
        });

        // Load configured users from server
        async function loadUsers() {
            try {
                const response = await fetch(basePath + '/api/users');
                configuredUsers = await response.json();

                // Generate user buttons dynamically
                const userButtonsContainer = document.getElementById('userButtons');
                userButtonsContainer.innerHTML = configuredUsers.map(user =>
                    `<button class="user-button" onclick="setUser('${user.name}')">${user.name}</button>`
                ).join('');

                console.log('Loaded users:', configuredUsers);
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load MIDI status
        async function loadMidiStatus() {
            try {
                const response = await fetch(basePath + '/api/midi/status');
                const data = await response.json();
                midiConnected = data.connected;
                updateMidiStatus(data.connected, data.device);
            } catch (error) {
                console.error('Error loading MIDI status:', error);
            }
        }

        // Update MIDI status display
        function updateMidiStatus(connected, deviceName) {
            const midiStatus = document.getElementById('midiStatus');
            const midiStatusText = document.getElementById('midiStatusText');
            const midiDeviceName = document.getElementById('midiDeviceName');
            const retryButton = document.getElementById('retryButton');

            if (connected) {
                midiStatus.className = 'midi-status connected';
                midiStatusText.textContent = 'USB Piano Connected';
                midiDeviceName.textContent = deviceName || '';
                retryButton.style.display = 'none';
            } else {
                midiStatus.className = 'midi-status disconnected';
                midiStatusText.textContent = 'USB is disconnected';
                midiDeviceName.textContent = 'Waiting for piano...';
                retryButton.style.display = 'block';
            }
        }

        // Retry MIDI connection
        async function retryMidiConnection() {
            const retryButton = document.getElementById('retryButton');
            retryButton.disabled = true;
            retryButton.textContent = 'Retrying...';

            try {
                const response = await fetch(basePath + '/api/midi/reconnect', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    midiConnected = true;
                    updateMidiStatus(true, data.device);
                } else {
                    // Still disconnected
                    setTimeout(() => {
                        retryButton.disabled = false;
                        retryButton.textContent = 'Retry Connection';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error retrying MIDI connection:', error);
                retryButton.disabled = false;
                retryButton.textContent = 'Retry Connection';
            }
        }

        // Load current status
        async function loadStatus() {
            try {
                const response = await fetch(basePath + '/api/status');
                const data = await response.json();

                if (data.active) {
                    currentSession = data;
                    startDurationTimer();
                } else {
                    currentSession = null;
                    stopDurationTimer();
                }

                updateStatus();
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        // Update status display
        function updateStatus() {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const sessionInfo = document.getElementById('sessionInfo');
            const sessionControls = document.getElementById('sessionControls');
            const userSelector = document.getElementById('userSelector');
            const userSelectorTitle = document.getElementById('userSelectorTitle');

            // Update user button highlighting
            document.querySelectorAll('.user-button').forEach(btn => {
                btn.classList.remove('active');
            });

            if (currentSession && currentSession.active) {
                statusIndicator.className = 'status-indicator active';
                statusText.textContent = `${currentSession.user} is practicing`;
                sessionInfo.style.display = 'grid';
                updateSessionInfo();

                // Show end session button and change user selector context
                sessionControls.className = 'session-controls active';
                userSelector.className = 'user-selector during-session';
                userSelectorTitle.textContent = 'Switch to:';

                // Highlight active user button (case-insensitive comparison)
                const userButtons = document.querySelectorAll('.user-button');
                userButtons.forEach(btn => {
                    if (btn.textContent.toLowerCase() === currentSession.user.toLowerCase()) {
                        btn.classList.add('active');
                    }
                });
            } else {
                statusIndicator.className = 'status-indicator inactive';
                const user = currentSession ? currentSession.user : 'unknown';
                statusText.textContent = `No active session (${user})`;
                sessionInfo.style.display = 'none';
                stopDurationTimer();

                // Hide end session button and restore user selector context
                sessionControls.className = 'session-controls';
                userSelector.className = 'user-selector';
                userSelectorTitle.textContent = "Who's practicing?";
            }
        }

        // Update session info
        function updateSessionInfo() {
            if (!currentSession || !currentSession.active) return;

            const duration = currentSession.duration || 0;
            const minutes = Math.floor(duration / 60);
            const seconds = Math.floor(duration % 60);
            document.getElementById('duration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('noteCount').textContent = currentSession.note_count || 0;
        }

        // Start duration timer
        function startDurationTimer() {
            stopDurationTimer();
            durationTimer = setInterval(() => {
                if (currentSession && currentSession.active) {
                    const elapsed = Date.now() / 1000 - currentSession.start_time;
                    currentSession.duration = elapsed;
                    updateSessionInfo();
                }
            }, 1000);
        }

        // Stop duration timer
        function stopDurationTimer() {
            if (durationTimer) {
                clearInterval(durationTimer);
                durationTimer = null;
            }
        }

        // Set user
        async function setUser(userId) {
            try {
                const response = await fetch(basePath + '/api/user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ user_id: userId })
                });

                const data = await response.json();
                console.log('User set:', data);

                // Update button highlighting immediately (case-insensitive comparison)
                document.querySelectorAll('.user-button').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.toLowerCase() === userId.toLowerCase()) {
                        btn.classList.add('active');
                    }
                });

                loadStatus();
            } catch (error) {
                console.error('Error setting user:', error);
            }
        }

        // Load recent sessions
        async function loadRecentSessions() {
            try {
                const response = await fetch(basePath + '/api/sessions/recent?limit=5');
                const sessions = await response.json();

                const sessionList = document.getElementById('recentSessions');

                if (sessions.length === 0) {
                    sessionList.innerHTML = '<li class="session-item">No recent sessions</li>';
                    return;
                }

                sessionList.innerHTML = sessions.map(session => {
                    const date = new Date(session.start_timestamp * 1000);
                    const duration = Math.round(session.duration_seconds / 60);

                    return `
                        <li class="session-item">
                            <span class="session-user">${session.user_id}</span>
                            <span class="session-details">
                                ${date.toLocaleDateString()} ${date.toLocaleTimeString()} -
                                ${duration} min, ${session.note_count} notes
                            </span>
                        </li>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading recent sessions:', error);
            }
        }

        // End current session
        async function endSession() {
            const endButton = document.getElementById('endSessionButton');
            endButton.disabled = true;
            endButton.textContent = 'Ending...';

            try {
                const response = await fetch(basePath + '/api/session/end', {
                    method: 'POST'
                });

                if (response.ok) {
                    console.log('Session ended successfully');
                    // Status will update via WebSocket event
                } else {
                    console.error('Failed to end session');
                    alert('Failed to end session');
                }
            } catch (error) {
                console.error('Error ending session:', error);
                alert('Error ending session');
            } finally {
                endButton.disabled = false;
                endButton.textContent = 'End Session';
            }
        }

        // Initial load
        loadUsers();
        loadMidiStatus();
        loadStatus();
        loadRecentSessions();
    </script>
</body>
</html>
