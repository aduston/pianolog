<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pianolog - Practice Tracker</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // Load KioskBoard dynamically with correct path for nginx proxy support
        // Store a promise that resolves when KioskBoard is loaded
        window.kioskBoardLoaded = new Promise((resolve, reject) => {
            const basePath = window.location.pathname.startsWith('/pianolog') ? '/pianolog' : '';
            const script = document.createElement('script');
            script.src = basePath + '/static/kioskboard/kioskboard-aio-2.3.0.min.js';
            script.onload = () => resolve();
            script.onerror = () => reject(new Error('Failed to load KioskBoard'));
            document.head.appendChild(script);
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .status-card {
            text-align: center;
        }

        .status-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-indicator.active {
            background-color: #4CAF50;
        }

        .status-indicator.inactive {
            background-color: #ccc;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .status-text {
            font-size: 1.5em;
            font-weight: 600;
            margin: 20px 0;
        }

        .session-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .info-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .info-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #667eea;
        }

        .user-selector {
            margin-top: 30px;
        }

        .user-selector h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .user-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .user-button {
            flex: 1;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border: 3px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .user-button.active {
            background: #667eea;
            color: white;
        }

        .recent-sessions {
            margin-top: 20px;
        }

        .recent-sessions h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .session-list {
            list-style: none;
        }

        .session-item {
            padding: 15px;
            background: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-item:hover {
            background: #f0f0f0;
        }

        .session-user {
            font-weight: 600;
            color: #667eea;
        }

        .session-details {
            color: #666;
            font-size: 0.9em;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            font-size: 0.9em;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .connection-status.connected {
            color: #4CAF50;
        }

        .connection-status.disconnected {
            color: #f44336;
        }

        .midi-status {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .midi-status.connected {
            border-left: 4px solid #4CAF50;
        }

        .midi-status.disconnected {
            border-left: 4px solid #f44336;
        }

        .midi-status-text {
            font-weight: 600;
        }

        .midi-status.connected .midi-status-text {
            color: #4CAF50;
        }

        .midi-status.disconnected .midi-status-text {
            color: #f44336;
        }

        .midi-device-name {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .retry-button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .retry-button:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .retry-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .session-controls {
            margin-top: 20px;
            display: none;
            gap: 10px;
        }

        .session-controls.active {
            display: flex;
            justify-content: center;
        }

        .end-session-button {
            padding: 12px 24px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .end-session-button:hover {
            background: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        .end-session-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .countdown-timer {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%);
            border-radius: 10px;
            text-align: center;
            animation: pulse-warning 1s infinite;
        }

        .countdown-timer.active {
            display: block;
        }

        .countdown-text {
            color: white;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .countdown-value {
            color: white;
            font-size: 3em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        @keyframes pulse-warning {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }

        .user-selector h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .user-selector.during-session h3 {
            font-size: 0.9em;
            color: #666;
        }

        /* Stats screen styles */
        .stats-screen {
            display: none;
        }

        .stats-screen.active {
            display: block;
        }

        .manage-users-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }

        .stats-screen.active .manage-users-button {
            display: block;
        }

        .manage-users-button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .practice-screen {
            display: none;
        }

        .practice-screen.active {
            display: block;
        }

        .user-stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) and (orientation: landscape) {
            .user-stats-grid {
                /* Don't use grid when carousel is active - let JS handle layout */
                display: block;
                margin-bottom: 0;
            }
        }

        .user-stats-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .user-stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-stats-name {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
        }

        .user-stats-target {
            font-size: 0.9em;
            color: #666;
        }

        .weekly-chart {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 150px;
            gap: 8px;
            margin-bottom: 10px;
        }

        .day-bar-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .day-bar {
            width: 100%;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            position: relative;
            min-height: 4px;
        }

        .day-bar.met-target {
            background: linear-gradient(180deg, #4CAF50 0%, #45a049 100%);
        }

        .day-bar.partial {
            background: linear-gradient(180deg, #FFA726 0%, #FB8C00 100%);
        }

        .day-bar.empty {
            background: #e0e0e0;
        }

        .day-label {
            font-size: 0.75em;
            color: #666;
            font-weight: 500;
        }

        .day-value {
            font-size: 0.7em;
            color: #999;
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .day-bar-container:hover .day-value {
            opacity: 1;
        }

        .stats-summary {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .stats-summary-item {
            text-align: center;
        }

        .stats-summary-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #667eea;
        }

        .stats-summary-label {
            font-size: 0.8em;
            color: #666;
            margin-top: 3px;
        }

        /* Responsive adjustments */
        @media (max-width: 767px) {
            header h1 {
                font-size: 2em;
            }

            .weekly-chart {
                height: 120px;
            }

            .user-stats-name {
                font-size: 1.2em;
            }
        }

        @media (orientation: portrait) {
            .user-stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Keep MIDI status visible on both screens */
        .midi-status-container {
            margin-bottom: 20px;
        }

        /* User management screen styles */
        .user-mgmt-screen {
            display: none;
        }

        .user-mgmt-screen.active {
            display: block;
        }

        .user-mgmt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .user-list {
            list-style: none;
            margin-bottom: 30px;
        }

        .user-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .user-info {
            flex: 1;
        }

        .user-info-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .user-info-note {
            font-size: 0.9em;
            color: #666;
        }

        .delete-user-button {
            padding: 8px 16px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .delete-user-button:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }

        .add-user-form {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .add-user-form h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .submit-button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .submit-button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .submit-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Stats carousel for landscape mode */
        @media (min-width: 768px) and (orientation: landscape) {
            .stats-carousel-container {
                position: relative;
                overflow: hidden;
                width: 100%;
                margin-bottom: 20px;
            }

            .stats-carousel {
                display: flex;
                transition: transform 0.3s ease;
                width: 100%;
            }

            .stats-carousel-page {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                min-width: 100%;
                flex-shrink: 0;
            }

            .carousel-nav {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin-top: 20px;
                width: 100%;
                position: relative;
                clear: both;
            }

            #carouselNavPlaceholder {
                display: block;
                width: 100%;
                text-align: center;
                margin-top: 10px;
                padding: 10px 0;
            }

            #carouselNavContainer {
                display: inline-block;
                text-align: center;
            }

            #carouselNavContainer button {
                display: inline-block;
                margin: 0 10px;
            }

            .carousel-button {
                padding: 15px 25px;
                background: rgba(255, 255, 255, 0.9);
                color: #667eea;
                border: 2px solid #667eea;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                font-size: 1.1em;
                transition: all 0.3s ease;
                min-width: 140px;
            }

            .carousel-button:hover:not(:disabled) {
                background: #667eea;
                color: white;
            }

            .carousel-button:disabled {
                opacity: 0.3;
                cursor: not-allowed;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">Connecting...</div>

    <div class="container">
        <header>
            <h1>üéπ Pianolog</h1>
            <p>Piano Practice Tracker <span style="font-size: 0.7em; opacity: 0.7;">v2.5-kb</span></p>
        </header>

        <!-- MIDI Status (shown on both screens) -->
        <div class="midi-status-container">
            <div class="midi-status" id="midiStatus">
                <div>
                    <div class="midi-status-text" id="midiStatusText">Checking MIDI...</div>
                    <div class="midi-device-name" id="midiDeviceName"></div>
                </div>
                <button class="retry-button" id="retryButton" onclick="retryMidiConnection()" style="display: none;">Retry Connection</button>
            </div>
        </div>

        <!-- Stats Screen (shown when idle) -->
        <div class="stats-screen" id="statsScreen">
            <button class="manage-users-button" onclick="showUserManagement()">Manage Users</button>
            <div class="user-stats-grid" id="userStatsGrid">
                <!-- User stats cards will be dynamically generated -->
            </div>
            <div id="carouselNavPlaceholder"></div>
        </div>

        <!-- User Management Screen -->
        <div class="user-mgmt-screen" id="userMgmtScreen">
            <div class="card">
                <div class="user-mgmt-header">
                    <h2>Manage Users</h2>
                    <button class="back-button" onclick="backToStats()">Back to Stats</button>
                </div>

                <h3>Current Users</h3>
                <ul class="user-list" id="userList">
                    <!-- User list will be dynamically generated -->
                </ul>

                <div class="add-user-form">
                    <h3>Add New User</h3>
                    <form id="addUserForm" onsubmit="addUser(event)">
                        <div class="form-group">
                            <label for="userName">Name:</label>
                            <input type="text" id="userName" name="userName" class="kioskboard-input" data-kioskboard-type="keyboard" required inputmode="text">
                        </div>
                        <div class="form-group">
                            <label for="userNote">MIDI Note (e.g., 60 for Middle C):</label>
                            <input type="number" id="userNote" name="userNote" class="kioskboard-input" data-kioskboard-type="numpad" min="0" max="127" required inputmode="numeric">
                        </div>
                        <button type="submit" class="submit-button" id="addUserSubmit">Add User</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Practice Screen (shown when practicing) -->
        <div class="practice-screen" id="practiceScreen">
            <div class="card status-card">
            <div class="status-text">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">Loading...</span>
            </div>

            <div class="session-info" id="sessionInfo" style="display: none;">
                <div class="info-box">
                    <div class="info-label">Duration</div>
                    <div class="info-value" id="duration">0:00</div>
                </div>
                <div class="info-box">
                    <div class="info-label">Notes Played</div>
                    <div class="info-value" id="noteCount">0</div>
                </div>
            </div>

            <div class="countdown-timer" id="countdownTimer">
                <div class="countdown-text">Session ending soon...</div>
                <div class="countdown-value" id="countdownValue">5</div>
            </div>

            <div class="session-controls" id="sessionControls">
                <button class="end-session-button" id="endSessionButton" onclick="endSession()">End Session</button>
            </div>
        </div>

            <div class="card recent-sessions">
                <h3>Recent Sessions</h3>
                <ul class="session-list" id="recentSessions">
                    <li class="session-item">Loading...</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Connect to WebSocket
        // Detect if we're behind a proxy at /pianolog/
        const basePath = window.location.pathname.startsWith('/pianolog') ? '/pianolog' : '';
        const socket = io({
            path: basePath + '/socket.io'
        });

        let currentSession = null;
        let durationTimer = null;
        let configuredUsers = [];
        let midiConnected = false;
        let weeklyStats = {};
        let statsRefreshInterval = null;
        let lastActivityTime = null;
        let countdownTimer = null;
        let countdownCheckInterval = null;
        let sessionTimeout = 30; // Default, will be loaded from config

        // Connection status
        socket.on('connect', () => {
            console.log('Connected to server');
            document.getElementById('connectionStatus').textContent = 'WebSocket Connected';
            document.getElementById('connectionStatus').className = 'connection-status connected';
            loadConfig();
            loadUsers();
            loadMidiStatus();
            loadStatus();
            loadRecentSessions();
            loadWeeklyStats();
            startStatsRefresh();
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
        });

        // Session events
        socket.on('session_started', (data) => {
            console.log('Session started:', data);
            currentSession = data;
            lastActivityTime = Date.now();
            startDurationTimer();
            startCountdownCheck();
            updateStatus();
            switchToScreen('practice');
            loadRecentSessions();
        });

        socket.on('session_ended', (data) => {
            console.log('Session ended:', data);
            currentSession = null;
            lastActivityTime = null;
            stopCountdownCheck();
            updateStatus();
            switchToScreen('stats');
            loadRecentSessions();
            loadWeeklyStats();  // Refresh stats after session ends
        });

        socket.on('session_activity', (data) => {
            console.log('Session activity:', data);
            if (currentSession) {
                currentSession.note_count = data.note_count;
                currentSession.duration = data.duration;
                updateSessionInfo();

                // Update last activity time and reset countdown
                lastActivityTime = Date.now();
                hideCountdown();
            }
        });

        socket.on('midi_connected', (data) => {
            console.log('MIDI connected:', data);
            midiConnected = true;
            updateMidiStatus(true, data.device);
        });

        socket.on('midi_disconnected', (data) => {
            console.log('MIDI disconnected:', data);
            midiConnected = false;
            updateMidiStatus(false, null);
        });

        // Load configuration from server
        async function loadConfig() {
            try {
                const response = await fetch(basePath + '/api/config');
                const config = await response.json();
                sessionTimeout = config.session_timeout;
                console.log('Loaded config: session_timeout =', sessionTimeout);
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Load configured users from server
        async function loadUsers() {
            try {
                const response = await fetch(basePath + '/api/users');
                configuredUsers = await response.json();
                console.log('Loaded users:', configuredUsers);
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load MIDI status
        async function loadMidiStatus() {
            try {
                const response = await fetch(basePath + '/api/midi/status');
                const data = await response.json();
                midiConnected = data.connected;
                updateMidiStatus(data.connected, data.device);
            } catch (error) {
                console.error('Error loading MIDI status:', error);
            }
        }

        // Update MIDI status display
        function updateMidiStatus(connected, deviceName) {
            const midiStatus = document.getElementById('midiStatus');
            const midiStatusText = document.getElementById('midiStatusText');
            const midiDeviceName = document.getElementById('midiDeviceName');
            const retryButton = document.getElementById('retryButton');

            if (connected) {
                midiStatus.className = 'midi-status connected';
                midiStatusText.textContent = 'USB Piano Connected';
                midiDeviceName.textContent = deviceName || '';
                retryButton.style.display = 'none';
                // Reset button state for next time
                retryButton.disabled = false;
                retryButton.textContent = 'Retry Connection';
            } else {
                midiStatus.className = 'midi-status disconnected';
                midiStatusText.textContent = 'USB is disconnected';
                midiDeviceName.textContent = 'Waiting for piano...';
                retryButton.style.display = 'block';
                // Only enable the button if it's not currently processing a retry
                if (retryButton.textContent === 'Retry Connection') {
                    retryButton.disabled = false;
                }
            }
        }

        // Retry MIDI connection
        async function retryMidiConnection() {
            const retryButton = document.getElementById('retryButton');
            retryButton.disabled = true;
            retryButton.textContent = 'Power cycling USB...';

            try {
                const response = await fetch(basePath + '/api/midi/reconnect', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    // Connection successful - MIDI status will be updated via WebSocket event
                    midiConnected = true;
                    updateMidiStatus(true, data.device);
                } else {
                    // Connection failed - keep button disabled and wait for connection
                    // The button will be re-enabled only when midi_connected event is received
                    retryButton.textContent = 'Waiting for piano...';
                }
            } catch (error) {
                console.error('Error retrying MIDI connection:', error);
                // On error, keep button disabled with waiting message
                retryButton.textContent = 'Waiting for piano...';
            }
        }

        // Load current status
        async function loadStatus() {
            try {
                const response = await fetch(basePath + '/api/status');
                const data = await response.json();

                if (data.active) {
                    currentSession = data;
                    // Don't set lastActivityTime here - wait for actual key press events
                    // This ensures countdown only triggers after real inactivity, not on page load
                    startDurationTimer();
                    startCountdownCheck();
                    switchToScreen('practice');
                } else {
                    currentSession = null;
                    lastActivityTime = null;
                    stopDurationTimer();
                    stopCountdownCheck();
                    switchToScreen('stats');
                }

                updateStatus();
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        // Update status display
        function updateStatus() {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const sessionInfo = document.getElementById('sessionInfo');
            const sessionControls = document.getElementById('sessionControls');

            if (currentSession && currentSession.active) {
                // Active session - show practice screen
                statusIndicator.className = 'status-indicator active';
                statusText.textContent = `${currentSession.user} is practicing`;
                sessionInfo.style.display = 'grid';
                updateSessionInfo();

                // Show end session button
                sessionControls.className = 'session-controls active';
            } else {
                // No active session - should be in stats screen, not practice screen
                // The practice screen UI doesn't need to be updated because we switch to stats
                stopDurationTimer();
            }
        }

        // Update session info
        function updateSessionInfo() {
            if (!currentSession || !currentSession.active) return;

            const duration = currentSession.duration || 0;
            const minutes = Math.floor(duration / 60);
            const seconds = Math.floor(duration % 60);
            document.getElementById('duration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('noteCount').textContent = currentSession.note_count || 0;
        }

        // Start duration timer
        function startDurationTimer() {
            stopDurationTimer();
            durationTimer = setInterval(() => {
                if (currentSession && currentSession.active) {
                    const elapsed = Date.now() / 1000 - currentSession.start_time;
                    currentSession.duration = elapsed;
                    updateSessionInfo();
                }
            }, 1000);
        }

        // Stop duration timer
        function stopDurationTimer() {
            if (durationTimer) {
                clearInterval(durationTimer);
                durationTimer = null;
            }
        }

        // Start countdown check (runs every 100ms to check if we should show countdown)
        function startCountdownCheck() {
            stopCountdownCheck();
            countdownCheckInterval = setInterval(() => {
                if (currentSession && currentSession.active && lastActivityTime) {
                    const timeSinceActivity = (Date.now() - lastActivityTime) / 1000;

                    // Show countdown after 10 seconds of inactivity
                    if (timeSinceActivity >= 10) {
                        // Calculate seconds remaining until session timeout
                        const secondsRemaining = Math.max(0, Math.ceil(sessionTimeout - timeSinceActivity));
                        showCountdown(secondsRemaining);

                        if (secondsRemaining === 0) {
                            hideCountdown();
                        }
                    } else {
                        hideCountdown();
                    }
                }
            }, 100);
        }

        // Stop countdown check
        function stopCountdownCheck() {
            if (countdownCheckInterval) {
                clearInterval(countdownCheckInterval);
                countdownCheckInterval = null;
            }
            hideCountdown();
        }

        // Show countdown timer with specified seconds
        function showCountdown(seconds) {
            const countdownTimer = document.getElementById('countdownTimer');
            const countdownValue = document.getElementById('countdownValue');

            countdownValue.textContent = seconds;
            countdownTimer.classList.add('active');
        }

        // Hide countdown timer
        function hideCountdown() {
            const countdownTimer = document.getElementById('countdownTimer');
            countdownTimer.classList.remove('active');
        }

        // Set user
        async function setUser(userId) {
            try {
                const response = await fetch(basePath + '/api/user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ user_id: userId })
                });

                const data = await response.json();
                console.log('User set:', data);

                // Update button highlighting immediately (case-insensitive comparison)
                document.querySelectorAll('.user-button').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.toLowerCase() === userId.toLowerCase()) {
                        btn.classList.add('active');
                    }
                });

                loadStatus();
            } catch (error) {
                console.error('Error setting user:', error);
            }
        }

        // Load recent sessions
        async function loadRecentSessions() {
            try {
                const response = await fetch(basePath + '/api/sessions/recent?limit=5');
                const sessions = await response.json();

                const sessionList = document.getElementById('recentSessions');

                if (sessions.length === 0) {
                    sessionList.innerHTML = '<li class="session-item">No recent sessions</li>';
                    return;
                }

                sessionList.innerHTML = sessions.map(session => {
                    const date = new Date(session.start_timestamp * 1000);
                    const duration = Math.round(session.duration_seconds / 60);

                    return `
                        <li class="session-item">
                            <span class="session-user">${session.user_id}</span>
                            <span class="session-details">
                                ${date.toLocaleDateString()} ${date.toLocaleTimeString()} -
                                ${duration} min, ${session.note_count} notes
                            </span>
                        </li>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading recent sessions:', error);
            }
        }

        // End current session
        async function endSession() {
            const endButton = document.getElementById('endSessionButton');
            endButton.disabled = true;
            endButton.textContent = 'Ending...';

            try {
                const response = await fetch(basePath + '/api/session/end', {
                    method: 'POST'
                });

                if (response.ok) {
                    console.log('Session ended successfully');
                    // Status will update via WebSocket event
                } else {
                    console.error('Failed to end session');
                    alert('Failed to end session');
                }
            } catch (error) {
                console.error('Error ending session:', error);
                alert('Error ending session');
            } finally {
                endButton.disabled = false;
                endButton.textContent = 'End Session';
            }
        }

        // Load weekly stats for all users
        async function loadWeeklyStats() {
            try {
                const response = await fetch(basePath + '/api/stats/weekly');
                weeklyStats = await response.json();
                renderStatsScreen();
            } catch (error) {
                console.error('Error loading weekly stats:', error);
            }
        }

        // Render the stats screen with weekly bar graphs
        function renderStatsScreen() {
            const userStatsGrid = document.getElementById('userStatsGrid');

            if (Object.keys(weeklyStats).length === 0) {
                userStatsGrid.innerHTML = '<p style="color: white; text-align: center;">Loading stats...</p>';
                return;
            }

            // Check if we're in landscape mode on a larger screen
            const isLandscape = window.matchMedia('(min-width: 768px) and (orientation: landscape)').matches;
            const userEntries = Object.entries(weeklyStats);

            if (isLandscape && userEntries.length > 2) {
                // Render with carousel for landscape mode
                renderStatsCarousel(userEntries);
            } else {
                // Render normal grid for portrait or when 2 or fewer users
                renderStatsGrid(userEntries);
            }
        }

        // Render stats in a simple grid
        function renderStatsGrid(userEntries) {
            const userStatsGrid = document.getElementById('userStatsGrid');
            userStatsGrid.innerHTML = userEntries.map(([userId, stats]) => {
                // Calculate summary stats
                const totalMinutes = stats.reduce((sum, day) => sum + day.minutes, 0);
                const daysMetTarget = stats.filter(day => day.met_target).length;
                const avgMinutes = (totalMinutes / stats.length).toFixed(1);
                const targetMinutes = stats[0]?.target_minutes || 15;

                // Generate bar chart
                const maxHeight = 150;
                const bars = stats.map(day => {
                    const heightPercentage = Math.min(100, day.percentage);
                    const height = Math.max(4, (heightPercentage / 100) * maxHeight);

                    let barClass = 'day-bar';
                    if (day.minutes === 0) {
                        barClass += ' empty';
                    } else if (day.met_target) {
                        barClass += ' met-target';
                    } else {
                        barClass += ' partial';
                    }

                    return `
                        <div class="day-bar-container">
                            <div class="${barClass}" style="height: ${height}px;">
                                <div class="day-value">${day.minutes}m</div>
                            </div>
                            <div class="day-label">${day.day_name}</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="user-stats-card">
                        <div class="user-stats-header">
                            <div class="user-stats-name">${userId}</div>
                            <div class="user-stats-target">Goal: ${targetMinutes} min/day</div>
                        </div>
                        <div class="weekly-chart">
                            ${bars}
                        </div>
                        <div class="stats-summary">
                            <div class="stats-summary-item">
                                <div class="stats-summary-value">${daysMetTarget}/7</div>
                                <div class="stats-summary-label">Days on track</div>
                            </div>
                            <div class="stats-summary-item">
                                <div class="stats-summary-value">${totalMinutes.toFixed(0)}m</div>
                                <div class="stats-summary-label">This week</div>
                            </div>
                            <div class="stats-summary-item">
                                <div class="stats-summary-value">${avgMinutes}m</div>
                                <div class="stats-summary-label">Daily avg</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        let currentCarouselPage = 0;

        // Render stats with carousel for landscape mode
        function renderStatsCarousel(userEntries) {
            const userStatsGrid = document.getElementById('userStatsGrid');
            const totalPages = Math.ceil(userEntries.length / 2);

            // Build carousel HTML
            let carouselHTML = '<div class="stats-carousel-container"><div class="stats-carousel" id="statsCarousel">';

            for (let page = 0; page < totalPages; page++) {
                const startIdx = page * 2;
                const pageUsers = userEntries.slice(startIdx, startIdx + 2);

                carouselHTML += '<div class="stats-carousel-page">';

                pageUsers.forEach(([userId, stats]) => {
                    const totalMinutes = stats.reduce((sum, day) => sum + day.minutes, 0);
                    const daysMetTarget = stats.filter(day => day.met_target).length;
                    const avgMinutes = (totalMinutes / stats.length).toFixed(1);
                    const targetMinutes = stats[0]?.target_minutes || 15;

                    const maxHeight = 150;
                    const bars = stats.map(day => {
                        const heightPercentage = Math.min(100, day.percentage);
                        const height = Math.max(4, (heightPercentage / 100) * maxHeight);

                        let barClass = 'day-bar';
                        if (day.minutes === 0) {
                            barClass += ' empty';
                        } else if (day.met_target) {
                            barClass += ' met-target';
                        } else {
                            barClass += ' partial';
                        }

                        return `
                            <div class="day-bar-container">
                                <div class="${barClass}" style="height: ${height}px;">
                                    <div class="day-value">${day.minutes}m</div>
                                </div>
                                <div class="day-label">${day.day_name}</div>
                            </div>
                        `;
                    }).join('');

                    carouselHTML += `
                        <div class="user-stats-card">
                            <div class="user-stats-header">
                                <div class="user-stats-name">${userId}</div>
                                <div class="user-stats-target">Goal: ${targetMinutes} min/day</div>
                            </div>
                            <div class="weekly-chart">
                                ${bars}
                            </div>
                            <div class="stats-summary">
                                <div class="stats-summary-item">
                                    <div class="stats-summary-value">${daysMetTarget}/7</div>
                                    <div class="stats-summary-label">Days on track</div>
                                </div>
                                <div class="stats-summary-item">
                                    <div class="stats-summary-value">${totalMinutes.toFixed(0)}m</div>
                                    <div class="stats-summary-label">This week</div>
                                </div>
                                <div class="stats-summary-item">
                                    <div class="stats-summary-value">${avgMinutes}m</div>
                                    <div class="stats-summary-label">Daily avg</div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                carouselHTML += '</div>';
            }

            carouselHTML += '</div></div>';

            userStatsGrid.innerHTML = carouselHTML;

            // Add navigation buttons if more than 1 page (insert into placeholder)
            const navPlaceholder = document.getElementById('carouselNavPlaceholder');

            if (totalPages > 1) {
                navPlaceholder.innerHTML = `
                    <div id="carouselNavContainer" class="carousel-nav">
                        <button class="carousel-button" id="prevButton" onclick="navigateCarousel(-1)">‚Üê Previous</button>
                        <button class="carousel-button" id="nextButton" onclick="navigateCarousel(1)">Next ‚Üí</button>
                    </div>
                `;
            } else {
                navPlaceholder.innerHTML = '';
            }

            // Reset to first page
            currentCarouselPage = 0;
            updateCarousel();
        }

        // Navigate carousel
        function navigateCarousel(direction) {
            const userEntries = Object.entries(weeklyStats);
            const totalPages = Math.ceil(userEntries.length / 2);

            currentCarouselPage += direction;

            if (currentCarouselPage < 0) {
                currentCarouselPage = 0;
            } else if (currentCarouselPage >= totalPages) {
                currentCarouselPage = totalPages - 1;
            }

            updateCarousel();
        }

        // Update carousel position
        function updateCarousel() {
            const carousel = document.getElementById('statsCarousel');
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            const userEntries = Object.entries(weeklyStats);
            const totalPages = Math.ceil(userEntries.length / 2);

            if (carousel) {
                carousel.style.transform = `translateX(-${currentCarouselPage * 100}%)`;
            }

            if (prevButton) {
                prevButton.disabled = currentCarouselPage === 0;
            }

            if (nextButton) {
                nextButton.disabled = currentCarouselPage === totalPages - 1;
            }
        }

        // Switch between stats and practice screens
        function switchToScreen(screenName) {
            const statsScreen = document.getElementById('statsScreen');
            const practiceScreen = document.getElementById('practiceScreen');
            const userMgmtScreen = document.getElementById('userMgmtScreen');

            if (screenName === 'stats') {
                statsScreen.classList.add('active');
                practiceScreen.classList.remove('active');
                userMgmtScreen.classList.remove('active');
            } else if (screenName === 'practice') {
                statsScreen.classList.remove('active');
                practiceScreen.classList.add('active');
                userMgmtScreen.classList.remove('active');
            } else if (screenName === 'user-mgmt') {
                statsScreen.classList.remove('active');
                practiceScreen.classList.remove('active');
                userMgmtScreen.classList.add('active');
            }
        }

        // Show user management screen
        function showUserManagement() {
            switchToScreen('user-mgmt');
            loadUserList();
        }

        // Back to stats screen
        function backToStats() {
            switchToScreen('stats');
            loadWeeklyStats();  // Refresh stats in case users were changed
        }

        // Load user list for management screen
        async function loadUserList() {
            try {
                const response = await fetch(basePath + '/api/users');
                const users = await response.json();

                const userList = document.getElementById('userList');

                if (users.length === 0) {
                    userList.innerHTML = '<li class="user-item">No users configured</li>';
                    return;
                }

                userList.innerHTML = users.map(user => `
                    <li class="user-item">
                        <div class="user-info">
                            <div class="user-info-name">${user.name}</div>
                            <div class="user-info-note">MIDI Note: ${user.note} (${midiNoteToName(user.note)})</div>
                        </div>
                        <button class="delete-user-button" onclick="deleteUser(${user.id}, '${user.name}')">Delete</button>
                    </li>
                `).join('');
            } catch (error) {
                console.error('Error loading user list:', error);
            }
        }

        // Convert MIDI note to note name
        function midiNoteToName(noteNumber) {
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const octave = Math.floor(noteNumber / 12) - 1;
            const note = noteNames[noteNumber % 12];
            return `${note}${octave}`;
        }

        // Add new user
        async function addUser(event) {
            event.preventDefault();

            const userName = document.getElementById('userName').value;
            const userNote = parseInt(document.getElementById('userNote').value);
            const submitButton = document.getElementById('addUserSubmit');

            submitButton.disabled = true;
            submitButton.textContent = 'Adding...';

            try {
                const response = await fetch(basePath + '/api/users/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: userName,
                        trigger_note: userNote
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Clear form
                    document.getElementById('addUserForm').reset();
                    // Reload user list
                    loadUserList();
                    // Reload users for practice screen
                    loadUsers();
                    alert(`User "${userName}" added successfully!`);
                } else {
                    alert(`Error adding user: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error adding user:', error);
                alert('Error adding user. Please try again.');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Add User';
            }
        }

        // Delete user
        async function deleteUser(userId, userName) {
            if (!confirm(`Are you sure you want to delete user "${userName}"? Their practice data will be preserved.`)) {
                return;
            }

            try {
                const response = await fetch(basePath + `/api/users/${userId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Reload user list
                    loadUserList();
                    // Reload users for practice screen
                    loadUsers();
                    alert(`User "${userName}" has been deleted.`);
                } else {
                    alert(`Error deleting user: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Error deleting user. Please try again.');
            }
        }

        // Start periodic stats refresh (every 5 minutes)
        function startStatsRefresh() {
            if (statsRefreshInterval) {
                clearInterval(statsRefreshInterval);
            }
            statsRefreshInterval = setInterval(() => {
                loadWeeklyStats();
            }, 5 * 60 * 1000);
        }

        // Update status display (modified to handle screen switching)
        function updateStatusAndScreen() {
            updateStatus();

            // Switch screens based on session state
            if (currentSession && currentSession.active) {
                switchToScreen('practice');
            } else {
                switchToScreen('stats');
            }
        }

        // Initialize KioskBoard for kiosk mode
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if we're in kiosk mode via URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const isKioskMode = urlParams.get('kiosk') === 'true';

            if (isKioskMode) {
                // Wait for KioskBoard to load before initializing
                try {
                    await window.kioskBoardLoaded;
                } catch (error) {
                    console.error('Failed to load KioskBoard:', error);
                    return;
                }

                // Initialize KioskBoard with light theme and default QWERTY layout
                KioskBoard.init({
                    keysArrayOfObjects: [
                        {"0": "Q", "1": "W", "2": "E", "3": "R", "4": "T", "5": "Y", "6": "U", "7": "I", "8": "O", "9": "P"},
                        {"0": "A", "1": "S", "2": "D", "3": "F", "4": "G", "5": "H", "6": "J", "7": "K", "8": "L"},
                        {"0": "Z", "1": "X", "2": "C", "3": "V", "4": "B", "5": "N", "6": "M"}
                    ],
                    keysArrayOfNumbers: [
                        {"0": "7", "1": "8", "2": "9"},
                        {"0": "4", "1": "5", "2": "6"},
                        {"0": "1", "1": "2", "2": "3"},
                        {"0": "0"}
                    ],
                    theme: 'light',
                    capsLockActive: false,
                    allowRealKeyboard: true,
                    allowMobileKeyboard: false,
                    cssAnimations: true,
                    cssAnimationsDuration: 360,
                    cssAnimationsStyle: 'slide',
                    keysAllowSpacebar: true,
                    keysSpacebarText: 'Space',
                    keysEnterText: 'Close',
                    keysEnterCanClose: true,
                    keysFontFamily: 'sans-serif',
                    keysFontSize: '22px',
                    keysFontWeight: 'normal',
                    keysIconSize: '25px',
                });

                // Run KioskBoard on all inputs (keyboard type determined by data-kioskboard-type attribute)
                KioskBoard.run('.kioskboard-input');

                // Auto-close keyboard on form submission
                const addUserForm = document.getElementById('addUserForm');
                if (addUserForm) {
                    addUserForm.addEventListener('submit', function() {
                        // Close KioskBoard after a brief delay to allow form submission
                        setTimeout(() => {
                            const activeKeyboard = document.querySelector('.kioskboard-wrapper');
                            if (activeKeyboard) {
                                activeKeyboard.remove();
                            }
                        }, 100);
                    });
                }
            }
        });

        // Initial load
        loadConfig();
        loadUsers();
        loadMidiStatus();
        loadStatus();
        loadRecentSessions();
        loadWeeklyStats();
        startStatsRefresh();
    </script>
</body>
</html>
